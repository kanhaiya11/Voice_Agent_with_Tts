{"version":3,"sources":["../../src/llm/tool_context.test.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2024 LiveKit, Inc.\n//\n// SPDX-License-Identifier: Apache-2.0\nimport { describe, expect, it } from 'vitest';\nimport { z } from 'zod';\nimport { type ToolOptions, tool } from './tool_context.js';\nimport { createToolOptions, oaiParams } from './utils.js';\n\ndescribe('Tool Context', () => {\n  describe('oaiParams', () => {\n    it('should handle basic object schema', () => {\n      const schema = z.object({\n        name: z.string().describe('The user name'),\n        age: z.number().describe('The user age'),\n      });\n\n      const result = oaiParams(schema);\n\n      expect(result).toMatchSnapshot();\n    });\n\n    it('should handle enum fields', () => {\n      const schema = z.object({\n        color: z.enum(['red', 'blue', 'green']).describe('Choose a color'),\n      });\n\n      const result = oaiParams(schema);\n\n      expect(result).toMatchSnapshot();\n    });\n\n    it('should handle array fields', () => {\n      const schema = z.object({\n        tags: z.array(z.string()).describe('List of tags'),\n      });\n\n      const result = oaiParams(schema);\n\n      expect(result).toMatchSnapshot();\n    });\n\n    it('should handle array of enums', () => {\n      const schema = z.object({\n        colors: z.array(z.enum(['red', 'blue', 'green'])).describe('List of colors'),\n      });\n\n      const result = oaiParams(schema);\n\n      expect(result).toMatchSnapshot();\n    });\n\n    it('should handle optional fields', () => {\n      const schema = z.object({\n        name: z.string().describe('The user name'),\n        age: z.number().optional().describe('The user age'),\n      });\n\n      const result = oaiParams(schema);\n\n      expect(result).toMatchSnapshot();\n    });\n\n    it('should handle fields without descriptions', () => {\n      const schema = z.object({\n        name: z.string(),\n        age: z.number(),\n      });\n\n      const result = oaiParams(schema);\n\n      expect(result).toMatchSnapshot();\n    });\n  });\n\n  describe('tool', () => {\n    it('should create and execute a basic core tool', async () => {\n      const getWeather = tool({\n        description: 'Get the weather for a given location',\n        parameters: z.object({\n          location: z.string(),\n        }),\n        execute: async ({ location }, { ctx }: ToolOptions<{ name: string }>) => {\n          return `The weather in ${location} is sunny, ${ctx.userData.name}`;\n        },\n      });\n\n      const result = await getWeather.execute(\n        { location: 'San Francisco' },\n        createToolOptions('123', { name: 'John' }),\n      );\n      expect(result).toBe('The weather in San Francisco is sunny, John');\n    });\n\n    it('should properly type a callable function', async () => {\n      const testFunction = tool({\n        description: 'Test function',\n        parameters: z.object({\n          name: z.string().describe('The user name'),\n          age: z.number().describe('The user age'),\n        }),\n        execute: async (args) => {\n          return `${args.name} is ${args.age} years old`;\n        },\n      });\n\n      const result = await testFunction.execute(\n        { name: 'John', age: 30 },\n        createToolOptions('123'),\n      );\n      expect(result).toBe('John is 30 years old');\n    });\n\n    it('should handle async execution', async () => {\n      const testFunction = tool({\n        description: 'Async test function',\n        parameters: z.object({\n          delay: z.number().describe('Delay in milliseconds'),\n        }),\n        execute: async (args) => {\n          await new Promise((resolve) => setTimeout(resolve, args.delay));\n          return args.delay;\n        },\n      });\n\n      const start = Date.now();\n      const result = await testFunction.execute({ delay: 100 }, createToolOptions('123'));\n      const duration = Date.now() - start;\n\n      expect(result).toBe(100);\n      expect(duration).toBeGreaterThanOrEqual(95); // Allow for small timing variations\n    });\n\n    describe('nested array support', () => {\n      it('should handle nested array fields', () => {\n        const schema = z.object({\n          items: z.array(\n            z.object({\n              name: z.string().describe('the item name'),\n              modifiers: z\n                .array(\n                  z.object({\n                    modifier_name: z.string(),\n                    modifier_value: z.string(),\n                  }),\n                )\n                .describe('list of the modifiers applied on this item, such as size'),\n            }),\n          ),\n        });\n        const result = oaiParams(schema);\n        expect(result).toMatchSnapshot();\n      });\n    });\n\n    describe('optional parameters', () => {\n      it('should create a tool without parameters', async () => {\n        const simpleAction = tool({\n          description: 'Perform a simple action',\n          execute: async () => {\n            return 'Action performed';\n          },\n        });\n\n        expect(simpleAction.type).toBe('function');\n        expect(simpleAction.description).toBe('Perform a simple action');\n        expect(simpleAction.parameters).toBeDefined();\n        expect(simpleAction.parameters._def.typeName).toBe('ZodObject');\n\n        const result = await simpleAction.execute({}, createToolOptions('123'));\n        expect(result).toBe('Action performed');\n      });\n\n      it('should handle tools with context but no parameters', async () => {\n        const greetUser = tool({\n          description: 'Greet the current user',\n          execute: async (_, { ctx }: ToolOptions<{ username: string }>) => {\n            return `Hello, ${ctx.userData.username}!`;\n          },\n        });\n\n        const result = await greetUser.execute({}, createToolOptions('123', { username: 'Alice' }));\n        expect(result).toBe('Hello, Alice!');\n      });\n\n      it('should create a tool that accesses tool call id without parameters', async () => {\n        const getCallId = tool({\n          description: 'Get the current tool call ID',\n          execute: async (_, { toolCallId }) => {\n            return `Tool call ID: ${toolCallId}`;\n          },\n        });\n\n        const result = await getCallId.execute({}, createToolOptions('test-id-456'));\n        expect(result).toBe('Tool call ID: test-id-456');\n      });\n    });\n  });\n});\n"],"mappings":"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","names":[]}